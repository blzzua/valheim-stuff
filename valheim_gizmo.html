<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arch Calculator (ComfyGizmo)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            display: flex; /* Це зберігаємо для центрування всього вмісту */
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }
        .controls label {
            display: flex;
            flex-direction: column;
            color: #ccc;
        }
        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%; 
            padding: 10px;
            border-radius: 8px;
            background-color: #444;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px; /* Додайте відступ для розділення */
        }
        .content {
            display: flex;
            justify-content: center;
            gap: 20px; /* Відступ між елементами */
            flex-wrap: wrap; /* Для адаптивності на менших екранах */
        }
        canvas {
            background-color: #222;
            border: 2px solid #555;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            flex-grow: 1;
            max-width: 800px;
        }
        .info {
            background-color: #444;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 20%;
            max-width: 600px;
            text-align: left;
            flex-grow: 1;
        }
        .info p {
            margin: 5px 0;
            font-size: 1.1em;
        }
        h1 {
            color: #d4a76c;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Arch Calculator (ComfyGizmo)</h1>

    <div class="controls">
        <label>Beam lenght (m):</label><input type="number" id="beamLength" value="2.0" step="1" min="0.1" max="999">
        <label>Gizmo-parameter (2-250):</label><input type="number" id="gizmoParam" value="8" min="2" max="250">
        <label>Number of beams (1-N):</label> <input type="number" id="beamsCount" value="8" min="1">
    </div>
    <div class="content">
        <canvas id="canvas" width="800" height="600"></canvas>
        <div class="info">
            <p>Rotation angle step: <span id="rotationStep"></span>°</p>
            <p>Starter angle (from ground): <span id="startAngle1"></span>°</p>
            <p>Starter angle (from vertical): <span id="startAngle2"></span>°</p>
            <p>Number of beams: <span id="polygonSides"></span></p>
            <p>Diameter (full polygon): <span id="diameter"></span> m</p>
            <p>Chord Length : <span id="chordLength"></span> m</p>
            <p>Arch Height: <span id="arcHeight"></span> m</p>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const beamLengthInput = document.getElementById('beamLength');
    const gizmoParamInput = document.getElementById('gizmoParam');
    const beamsCountInput = document.getElementById('beamsCount');

    const rotationStepSpan = document.getElementById('rotationStep');
    const startAngle1Span = document.getElementById('startAngle1');
    const startAngle2Span = document.getElementById('startAngle2');
    const polygonSidesSpan = document.getElementById('polygonSides');
    const diameterSpan = document.getElementById('diameter');
    const chordLengthSpan = document.getElementById('chordLength');
    const arcHeightSpan = document.getElementById('arcHeight');

    function drawPolygonPart() {
        // Очищаємо полотно
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Отримуємо значення з полів вводу
        const beamLength = parseFloat(beamLengthInput.value);
        const gizmoParam = parseInt(gizmoParamInput.value);
        const beamsCount = parseInt(beamsCountInput.value);

        if (isNaN(beamLength) || isNaN(gizmoParam) || isNaN(beamsCount) || gizmoParam < 2 || gizmoParam > 250 || beamsCount < 1 || beamsCount > gizmoParam * 2 ) {
            // Виводимо повідомлення про помилку, якщо дані некоректні
            rotationStepSpan.textContent = "Некоректні дані";
            polygonSidesSpan.textContent = "Некоректні дані";
            diameterSpan.textContent = "Некоректні дані";
            chordLengthSpan.textContent = "Некоректні дані";
            arcHeightSpan.textContent = "Некоректні дані";
            return;
        }

        // --- Розрахунки ---
        const rotationStepDegrees = 180.0 / gizmoParam;
        const polygonSidesCount = 360.0 / rotationStepDegrees;
        const angleRad = Math.PI / polygonSidesCount; // Кут, що спирається на одну сторону в центрі кола
        const radius = beamLength / (2 * Math.sin(angleRad)); // Радіус описаного кола
        const diameter = radius * 2;
        const centralAngleRad = beamsCount * (2 * angleRad); // Загальний кут, що охоплює всі балки
        const chordLength = 2 * radius * Math.sin(centralAngleRad / 2);
        
        // Висота арки (стріла сегмента)
        const arcHeight = radius - radius * Math.cos(centralAngleRad / 2);

        // Обмежуємо кількість балок до загальної кількості сторін багатокутника
        beamsCountInput.max = polygonSidesCount;
        if (beamsCount > polygonSidesCount) {
             beamsCountInput.value = Math.floor(polygonSidesCount); // Округляємо до цілого, щоб уникнути нескінченного циклу
        }

        // --- Візуалізація ---
        // Визначаємо масштаб, щоб малюнок помістився на канвасі
        // Враховуємо висоту арки і простір для тексту під хордою
        const textMarginBelowChord = 1.0; // Додатковий відступ для тексту під хордою в "метрах"
        const totalDrawingHeightInUnits = arcHeight + textMarginBelowChord;
        console.log("totalDrawingHeightInUnits=",totalDrawingHeightInUnits)

        const paddingFactor = 1.2; // Додаємо 20% відступу
        const scaleX = canvas.width / (chordLength * paddingFactor);
        const scaleY = canvas.height / (totalDrawingHeightInUnits * paddingFactor);
        const scale = Math.min(scaleX, scaleY, 100); // Обмежуємо максимальний масштаб

        // Переміщуємо початок координат канвасу
        // X: Центр канвасу
        // Y: Зміщуємо вниз, щоб арка і текст помістились.
        // Точка (0,0) в нашій масштабованій системі буде серединою хорди.
        // Робимо так, щоб середина хорди була приблизно на 70% висоти канвасу,
        // це залишить місце для арки вгорі та тексту внизу.
        const translateY = canvas.height * 0.7; 
        ctx.save();
        ctx.translate(canvas.width / 2, translateY);

        // Масштабуємо малюнок
        ctx.scale(scale, scale);

        // Початковий кут для першої балки (ліва крайня точка арки)
        // Робимо арку симетричною відносно вертикальної осі (кут PI/2)
        const startAngle = Math.PI / 2 + centralAngleRad / 2;
        let currentAngle = startAngle;
        
        //let startAngleDegrees = 90-(beamsCount)*(180/(gizmoParam))-(180/(gizmoParam))/2 ;
        const startAngleDegrees = 90-180*(((beamsCount-1) * (2 * angleRad)) / 2)/Math.PI;
        
        // Обчислюємо першу точку (початок арки) відносно центру кола, потім зміщуємо до хорди
        // (0,0) в масштабованій системі - це середина хорди.
        // Центр кола, з якого будується арка, знаходиться на осі Y, на відстані 'radius' від вершини арки.
        // Його Y-координата відносно хорди буде -arcHeight + radius = radius * cos(centralAngleRad / 2)
        const circleCenterX = 0; // Центр кола знаходиться на осі Y
        //const circleCenterY = 10 + (-arcHeight + radius);
        const circleCenterY = +arcHeight - radius; 

        // Початкова точка арки
        let x_start_arc = radius * Math.cos(currentAngle) + circleCenterX;
        let y_start_arc = radius * Math.sin(currentAngle) + circleCenterY;

        ctx.strokeStyle = '#a4b2c1'; // Колір арки
        ctx.lineWidth = 0.1; // Товщина ліній арки

        ctx.beginPath();
        ctx.moveTo(x_start_arc, -y_start_arc); // Застосовуємо інверсію Y для канвасу
        let middle_arch_y = 0;
        // Малюємо балки
        for (let i = 0; i < beamsCount; i++) {
            currentAngle -= (2 * angleRad); // Переходимо до наступної точки
            const x_next_arc = radius * Math.cos(currentAngle) + circleCenterX;
            const y_next_arc = radius * Math.sin(currentAngle) + circleCenterY;
            if (i === Math.floor(beamsCount / 2)-1) {
                middle_arch_y = y_next_arc; 
            };
            console.log(`x:${x_next_arc}, y:${y_next_arc}`)
            ctx.lineTo(x_next_arc, -y_next_arc); // Застосовуємо інверсію Y
        }
        ctx.stroke();

        // Обчислюємо останню точку (кінець арки) для малювання хорди
        const x_end_arc = radius * Math.cos(currentAngle) + circleCenterX;
        const y_end_arc = radius * Math.sin(currentAngle) + circleCenterY;

        // Малюємо хорду
        ctx.beginPath();
        ctx.moveTo(x_start_arc, -y_start_arc);
        ctx.lineTo(x_end_arc, -y_end_arc);
        ctx.strokeStyle = '#d4a76c'; // Колір хорди
        ctx.setLineDash([0.3, 0.3]); // Пунктирна лінія
        ctx.stroke();
        ctx.setLineDash([]); // Скидаємо стиль лінії

        // Малюємо лінію висоти арки
        ctx.beginPath();
        ctx.moveTo(0, -(y_start_arc+y_end_arc)/ 2); // Середина хорди
        ctx.lineTo(0, -middle_arch_y); // Вершина арки
        ctx.strokeStyle = '#6c96d4'; // Колір лінії висоти
        ctx.stroke();

        // --- Текстові підписи на канвасі ---
        ctx.fillStyle = '#fff';
        // Розмір шрифту залежить від довжини балки
        ctx.font = `${0.275 * beamLength}px Arial`; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // Підпис довжини хорди
        
        //ctx.fillText(chordLength.toFixed(2) + ' м', 0, textMarginBelowChord); // Розміщуємо під хордою
        ctx.fillText(chordLength.toFixed(2) + ' м ', 0, -(y_start_arc) + beamLength * 0.275 ); // Розміщуємо під хордою
        // Підпис висоти арки
        ctx.save();

        let height_arch_text_y = -((y_start_arc+y_end_arc)/2 + middle_arch_y)/2
        ctx.translate(textMarginBelowChord / 2, height_arch_text_y); // Розміщуємо праворуч від лінії висоти
        ctx.rotate(-Math.PI / 2); // Обертаємо текст вертикально
        ctx.fillText(arcHeight.toFixed(2) + ' м', 0, 0);
        ctx.restore();

        ctx.restore(); // Відновлюємо початковий стан канвасу

        // --- Оновлення текстової інформації в HTML ---
        rotationStepSpan.textContent = rotationStepDegrees.toFixed(2);
        //startAngle1Span.textContent = ((180*startAngle/Math.PI)-90).toFixed(2);
        startAngle1Span.textContent = (startAngleDegrees).toFixed(2);
        startAngle2Span.textContent = (90-startAngleDegrees).toFixed(2);
        polygonSidesSpan.textContent = Math.round(polygonSidesCount);
        diameterSpan.textContent = diameter.toFixed(2);
        chordLengthSpan.textContent = chordLength.toFixed(2);
        arcHeightSpan.textContent = arcHeight.toFixed(2);
        
    }

    // Запускаємо функцію при завантаженні сторінки та при зміні значень
    beamLengthInput.addEventListener('input', drawPolygonPart);
    gizmoParamInput.addEventListener('input', drawPolygonPart);
    beamsCountInput.addEventListener('input', drawPolygonPart);
    
    // Перший запуск при завантаженні сторінки
    drawPolygonPart();
</script>

</body>
</html>
