<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arch Calculator (ComfyGizmo)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }
        .controls label {
            display: flex;
            flex-direction: column;
            color: #ccc;
        }
        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%; 
            padding: 10px;
            border-radius: 8px;
            background-color: #444;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .content {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        canvas {
            background-color: #222;
            border: 2px solid #555;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            flex-grow: 1;
            max-width: 800px;
        }
        .info {
            background-color: #444;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 20%;
            max-width: 600px;
            text-align: left;
            flex-grow: 1;
        }
        .info p {
            margin: 5px 0;
            font-size: 1.1em;
        }
        h1 {
            color: #d4a76c;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Arch Calculator (ComfyGizmo)</h1>

    <div class="controls">
        <label>Beam Length (m):</label><input type="number" id="beamLength" value="2.0" step="1" min="0" max="999">
        <label>Gizmo-parameter (2-250):</label><input type="number" id="gizmoParam" value="8" min="2" max="250">
        <label>Number of beams (1-N):</label> <input type="number" id="beamsCount" value="8" min="1">
    </div>
    <div class="content">
        <canvas id="canvas" width="800" height="600"></canvas>
        <div class="info">
            <p>Rotation angle step: <span id="rotationStep"></span>°</p>
            <p>Starter angle (from ground): <span id="startAngle1"></span>°</p>
            <p>Starter angle (from vertical): <span id="startAngle2"></span>°</p>
            <p>Number of beams: <span id="polygonSides"></span></p>
            <p>Diameter (full polygon): <span id="diameter"></span> m</p>
            <p>Chord Length : <span id="chordLength"></span> m</p>
            <p>Arch Height: <span id="arcHeight"></span> m</p>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const beamLengthInput = document.getElementById('beamLength');
    const gizmoParamInput = document.getElementById('gizmoParam');
    const beamsCountInput = document.getElementById('beamsCount');

    const rotationStepSpan = document.getElementById('rotationStep');
    const startAngle1Span = document.getElementById('startAngle1');
    const startAngle2Span = document.getElementById('startAngle2');
    const polygonSidesSpan = document.getElementById('polygonSides');
    const diameterSpan = document.getElementById('diameter');
    const chordLengthSpan = document.getElementById('chordLength');
    const arcHeightSpan = document.getElementById('arcHeight');

    function drawPolygonPart() {
        // clean canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Getting values from input fields
        const beamLength = parseFloat(beamLengthInput.value);
        const gizmoParam = parseInt(gizmoParamInput.value);
        const beamsCount = parseInt(beamsCountInput.value);

        if (isNaN(beamLength) || isNaN(gizmoParam) || isNaN(beamsCount) || gizmoParam < 2 || gizmoParam > 250 || beamsCount < 1 || beamsCount > gizmoParam * 2 || beamLength < 0.1 ) {
            // We display an error message if the data is incorrect
            rotationStepSpan.textContent = "incorrect input";
            polygonSidesSpan.textContent = "incorrect input";
            diameterSpan.textContent = "incorrect input";
            chordLengthSpan.textContent = "incorrect input";
            startAngle1Span.textContent = "incorrect input";
            startAngle2Span.textContent = "incorrect input";
            arcHeightSpan.textContent = "incorrect input";
            return;
        }

        // --- calc ---
        const rotationStepDegrees = 180.0 / gizmoParam;
        const polygonSidesCount = 360.0 / rotationStepDegrees;
        const angleRad = Math.PI / polygonSidesCount; // An angle that rests on one side at the center of a circle
        const radius = beamLength / (2 * Math.sin(angleRad)); // Radius of the circumscribed circle
        const diameter = radius * 2;
        const centralAngleRad = beamsCount * (2 * angleRad); // The total angle(radians) covering all beams
        const chordLength = 2 * radius * Math.sin(centralAngleRad / 2);
        
        // Arch height (segment boom)
        const arcHeight = radius - radius * Math.cos(centralAngleRad / 2);

        // Limit the number of beams to the total number of sides of the polygon
        beamsCountInput.max = polygonSidesCount;
        if (beamsCount > polygonSidesCount) {
             beamsCountInput.value = Math.floor(polygonSidesCount); // Округляємо до цілого, щоб уникнути нескінченного циклу
        }

        // --- Visualization ---
        // We determine the scale so that the drawing fits on the canvas
        // We take into account the height of the arch and the space for text under the chord
        const textMarginBelowChord = 1.0; // Additional indentation for text under a chord in "meters"
        const totalDrawingHeightInUnits = arcHeight + textMarginBelowChord;
        console.log("totalDrawingHeightInUnits=",totalDrawingHeightInUnits)

        const paddingFactor = 1.2; // add 20% paddign
        const scaleX = canvas.width / (chordLength * paddingFactor);
        const scaleY = canvas.height / (totalDrawingHeightInUnits * paddingFactor);
        const scale = Math.min(scaleX, scaleY, 100); 

        // Move the canvas origin
        // X: Center of the canvas
        // Y: Move down so that the arch and text fit.
        // The point (0,0) in our scaled system will be the middle of the chord.
        // We make the middle of the chord about 70% of the height of the canvas,
        // this will leave room for the arch at the top and the text at the bottom.
        const translateY = canvas.height * 0.7; 
        ctx.save();
        ctx.translate(canvas.width / 2, translateY);

        // Scaling the drawing
        ctx.scale(scale, scale);

        // Starting angle for the first beam (leftmost point of the arch)
        // Make the arch symmetrical about the vertical axis (angle PI/2)
        const startAngle = Math.PI / 2 + centralAngleRad / 2;
        let currentAngle = startAngle;
        
        //let startAngleDegrees = 90-(beamsCount)*(180/(gizmoParam))-(180/(gizmoParam))/2 ;
        const startAngleDegrees = 90-180*(((beamsCount-1) * (2 * angleRad)) / 2)/Math.PI;
        
        // Calculate the first point (the beginning of the arch) relative to the center of the circle, then shift to the chord
        // (0,0) in the scaled system is the middle of the chord.
        // The center of the circle from which the arch is built is on the Y axis, at a distance 'radius' from the top of the arch.
        // Its Y-coordinate relative to the chord will be -arcHeight + radius = radius * cos(centralAngleRad / 2)
        const circleCenterX = 0; 
        const circleCenterY = +arcHeight - radius; 

        let x_start_arc = radius * Math.cos(currentAngle) + circleCenterX;
        let y_start_arc = radius * Math.sin(currentAngle) + circleCenterY;

        ctx.strokeStyle = '#a4b2c1'; // arch
        ctx.lineWidth = 0.2; // arch

        ctx.beginPath();
        ctx.moveTo(x_start_arc, -y_start_arc);
        let middle_arch_y = 0;

        // Drawing beams
        for (let i = 0; i < beamsCount; i++) {
            currentAngle -= (2 * angleRad); 
            const x_next_arc = radius * Math.cos(currentAngle) + circleCenterX;
            const y_next_arc = radius * Math.sin(currentAngle) + circleCenterY;
            if (i === Math.floor(beamsCount / 2)-1) {
                middle_arch_y = y_next_arc; 
            };
            console.log(`x:${x_next_arc}, y:${y_next_arc}`)
            ctx.lineTo(x_next_arc, -y_next_arc); 
        }
        ctx.stroke();

        const x_end_arc = radius * Math.cos(currentAngle) + circleCenterX;
        const y_end_arc = radius * Math.sin(currentAngle) + circleCenterY;

        // chord
        ctx.lineWidth = 0.05
        ctx.beginPath();
        
        ctx.moveTo(x_start_arc, -y_start_arc);
        ctx.lineTo(x_end_arc, -y_end_arc);
        ctx.strokeStyle = '#d4a76c';
        ctx.setLineDash([1, 1]); // dash
        ctx.stroke();
        ctx.setLineDash([]); // reset line style

        // arch height
        ctx.lineWidth = 0.05
        ctx.beginPath();
        ctx.moveTo(0, -(y_start_arc+y_end_arc)/ 2); // center of choird
        ctx.lineTo(0, -middle_arch_y); 
        ctx.strokeStyle = '#6c96d4'; 
        ctx.setLineDash([1, 1]); // dash
        ctx.stroke();

        // --- text signs  ---
        ctx.fillStyle = '#fff';
        ctx.font = `${0.275 * beamLength}px Arial`; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

       
        ctx.fillText(chordLength.toFixed(2) + ' м ', 0, -(y_start_arc) + beamLength * 0.275 );
        ctx.save();

        let height_arch_text_y = -((y_start_arc+y_end_arc)/2 + middle_arch_y)/2
        ctx.translate(textMarginBelowChord / 2, height_arch_text_y); // Розміщуємо праворуч від лінії висоти
        ctx.rotate(-Math.PI / 2); // Обертаємо текст вертикально
        ctx.fillText(arcHeight.toFixed(2) + ' м', 0, 0);
        ctx.restore();

        ctx.restore(); 

        // --- Updating text information in HTML ---
        rotationStepSpan.textContent = rotationStepDegrees.toFixed(2);
        startAngle1Span.textContent = (startAngleDegrees).toFixed(2);
        startAngle2Span.textContent = (90-startAngleDegrees).toFixed(2);
        polygonSidesSpan.textContent = Math.round(polygonSidesCount);
        diameterSpan.textContent = diameter.toFixed(2);
        chordLengthSpan.textContent = chordLength.toFixed(2);
        arcHeightSpan.textContent = arcHeight.toFixed(2);
        
    }

    // We run the function when the page loads and when the values change
    beamLengthInput.addEventListener('input', drawPolygonPart);
    gizmoParamInput.addEventListener('input', drawPolygonPart);
    beamsCountInput.addEventListener('input', drawPolygonPart);
    
    // First launch on page load
    drawPolygonPart();
</script>

</body>
</html>
